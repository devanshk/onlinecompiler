#!/bin/bash

# settings
#SERVER='faust@macyann.grame.fr'
SERVER='yannorlarey@localhost'
SSHOPTIONS='-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no'


# parameters SCRIPT=$1 FILE=$2 OPT=remaining
SCRIPT=$1
FILE=$2
shift 
shift
OPT=$*

#echo script=$SCRIPT file=$FILE options=$OPT

# produce binary.zip on remote server
TMP=`ssh $SSHOPTIONS $SERVER "mktemp -d fwtemp.XXXXXX"`
CMD="cd $TMP; /usr/local/bin/runInFaustEnv $SCRIPT $OPT $FILE"

#echo command="$CMD"

scp $SSHOPTIONS "$FILE" "$SERVER:$TMP/"
ssh $SSHOPTIONS "$SERVER" "$CMD"
ssh $SSHOPTIONS "$SERVER" "rm $TMP/$FILE"
ssh $SSHOPTIONS "$SERVER" "cd $TMP; zip -r binary.zip *"
scp $SSHOPTIONS "$SERVER:$TMP/binary.zip" .
ssh $SSHOPTIONS "$SERVER" "rm -rf $TMP"

